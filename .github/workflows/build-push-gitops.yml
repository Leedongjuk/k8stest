name: build-push-and-gitops

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build_push_gitops:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag (commit SHA)
        shell: powershell
        run: |
          "IMAGE_TAG=$env:GITHUB_SHA" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Configure AWS credentials (Access Key)
        shell: powershell
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set default.region "ap-northeast-2"

      - name: Login to ECR
        shell: powershell
        run: |
          aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 401670234592.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: Build & Push image to ECR
        shell: powershell
        run: |
          docker build -f Dockerfile.dockerfile -t 401670234592.dkr.ecr.ap-northeast-2.amazonaws.com/dong/dongtest:$env:IMAGE_TAG .
          docker push 401670234592.dkr.ecr.ap-northeast-2.amazonaws.com/dong/dongtest:$env:IMAGE_TAG

      - name: Update manifest image tag (GitOps)
        shell: powershell
        run: |
          $file = "apps/was/was-deployment.yaml"
          $content = Get-Content $file -Raw
          $pattern = "401670234592\.dkr\.ecr\.ap-northeast-2\.amazonaws\.com/dong/dongtest:[^\s`"]+"
          $replace = "401670234592.dkr.ecr.ap-northeast-2.amazonaws.com/dong/dongtest:$env:IMAGE_TAG"
          $new = [regex]::Replace($content, $pattern, $replace)
          Set-Content -Path $file -Value $new -NoNewline

      - name: Commit & push manifest update
        shell: powershell
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add apps/was/was-deployment.yaml

          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No changes to commit"
            exit 0
          }

          git commit -m "chore(gitops): deploy $env:IMAGE_TAG"
          git push origin main