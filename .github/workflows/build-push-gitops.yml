name: build-push-and-gitops

on:
  push:
    branches: ["main"]

permissions:
  contents: write

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: 401670234592.dkr.ecr.ap-northeast-2.amazonaws.com
  ECR_REPOSITORY: dong/dongtest

jobs:
  build_push_gitops:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag (commit SHA)
        shell: powershell
        run: |
          "IMAGE_TAG=$env:GITHUB_SHA" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Configure AWS credentials
        shell: powershell
        run: |
          aws configure set aws_access_key_id "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws configure set default.region "${{ env.AWS_REGION }}"

      - name: Verify AWS account (debug)
        shell: powershell
        run: |
          aws sts get-caller-identity
          aws ecr describe-repositories --region $env:AWS_REGION --repository-names "${{ env.ECR_REPOSITORY }}"

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push image to ECR
        shell: powershell
        run: |
          docker version
          docker build -f Dockerfile.dockerfile -t $env:ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$env:IMAGE_TAG .
          docker push $env:ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:$env:IMAGE_TAG

      # 아래는 필요 시 다시 활성화
      - name: Update manifest image tag (GitOps)
        shell: powershell
        run: |
          $file = "apps/was/was-deployment.yaml"
          $content = Get-Content $file -Raw
          $new = $content -replace "\(IMAGE_TAG\)", "$env:IMAGE_TAG"
          Set-Content -Path $file -Value $new -NoNewline
      
      - name: Commit & push manifest update
        shell: powershell
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add apps/was/was-deployment.yaml
          git commit -m "chore(gitops): deploy $env:IMAGE_TAG"
          git push